#!/usr/bin/env bash
set -e

#repos=(local:/tmp/backup)
#budirs=(~/work ~/Documents)
. $0.settings

if [[ $# = 1 && "$1" = "--list-repos" ]]; then
    for repo in "${repos[@]}"; do
        echo "$repo"
    done
    exit
fi

if [[ $# != 0 ]]; then
    repos=("$@")
fi

for repo in "${repos[@]}"; do
    export RESTIC_REPOSITORY=$repo
    export RESTIC_PASSWORD=$(pass show "restic/$repo")
    if ! restic cat config >/dev/null 2>&1; then
        echo $(tput setab 1)SKIPPING$(tput sgr0) $repo
        echo
        continue
    fi

    snapspec=(--tag bu)
    args=(backup "${snapspec[@]}")
    parent=$(restic snapshots "${snapspec[@]}" --json |jq -r "last .id")
    if [[ $parent != null ]]; then
        args+=(--parent $parent)
    fi
    args+=("${budirs[@]}")

    set -x
    restic "${args[@]}"
    set +x
done
