#!/usr/bin/env bash
set -e

#repos=(local:/tmp/backup)
#budirs=(~/work ~/Documents)
. $0.settings

for repo in "${repos[@]}"; do
    export RESTIC_PASSWORD=$(pass show "restic/$repo")
    snapspec=(--repo "$repo" --tag bu)
    args=(backup "${snapspec[@]}")
    parent=$(restic snapshots "${snapspec[@]}" --json |jq -r "last .id")
    if [[ $parent != null ]]; then
        args+=(--parent $parent)
    fi
    args+=("${budirs[@]}")

    set -x
    restic "${args[@]}"
    set +x
done
