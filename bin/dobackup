#!/usr/bin/env bash
set -e

#repos=(local:/tmp/backup)
#budirs=(~/work ~/Documents)
#stage=/backup
. $0.settings

prereqs=(/nix ~/.nix-profile)
for dir in "${prereqs[@]}"; do
    binds+=(--ro-bind "$dir" "$dir")
done

for dir in "${budirs[@]}"; do
    binds+=(--ro-bind "$dir" "$stage"/"$(basename "$dir")")
    budirnames+=("$(basename "$dir")")
done

for repo in "${repos[@]}"; do
    export RESTIC_PASSWORD=$(pass show "restic/$repo")
    snapspec=(--repo "$repo" --host anyhost --tag bu)
    parent=$(restic snapshots "${snapspec[@]}" --json |jq -r "last .id")

    args_bwrap=(--chdir "$stage" "${binds[@]}" --tmpfs /tmp)
    if [[ $repo == local:* ]]; then
        repodir=${repo#local:}
        args_bwrap+=(--bind "$repodir" "$repodir")
    fi

    set -x
    bwrap "${args_bwrap[@]}" -- \
      restic backup "${snapspec[@]}" --parent $parent "${budirnames[@]}"
    set +x
done
